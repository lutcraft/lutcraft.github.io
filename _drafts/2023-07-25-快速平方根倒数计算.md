---
layout: post
title: 成员变量与就近原则
categories: C, algorithm
description: 
keywords: computer graphics
mathjax: true
---

# 更快的平方根倒数计算

计算机图形学中，常常会使用一些数学方法，在可接受的精度范围内，加速一些经常进行的数学运算。比如对三维空间进行二维投影时，这就需要对这两个几何体面上的大量点，进行距离$(\sqrt{a^2+b^2+c^2})$倒数的运算投影到摄影机空间，使得物体在二维平面也可以符合近大远小的透视关系：
$$ \alpha = {a \over \sqrt{a^2+b^2+c^2}}(1)$$
$$ \beta = {b \over \sqrt{a^2+b^2+c^2}}(2)$$
$$ \zeta = {c \over \sqrt{a^2+b^2+c^2}}(3)$$

在上面的过程中，形如下式的函数将被大量计算：

$$y = {1 \over \sqrt{a^2+b^2+c^2}}(4)$$

而且这些计算都是浮点数计算，每秒成千上万次类似的浮点运算，会导致对这个过程进行优化将获得很大的性能提升。

首先，我们对式1进行化简：

$$a^2+b^2+c^2=x$$
$$d = {1 \over \sqrt{x}}$$

两端同时取对数：
$$ \log_2{d} = - {1 \over 2 } \log_2{x}$$

另，因为知道浮点数的近似表达公式为：
$$ (1+m)\times 2^e$$ 

代入上式：

$$ \log_2({(1+m_y)\times 2^{e_y}}) = - {1 \over 2 } \log_2({(1+m_x)\times 2^{e_x}})$$

对$\log_2{(1+m_y)}$进行线性化：
$$\log_2{(1+m_y)} \approx m+\alpha$$

代入原式：
$$ m_y+\alpha + e_y = - {1 \over 2 } (m_x+\alpha) + e_x$$


$$ I_y  \approx R - {1\over 2} I_x$$

基于这种算法，早在1999年就在游戏《雷神之锤》被应用，源码函数如下：
```
float Q_rsqrt( float number )
{
    long i;
    float x2, y;
    const float threehalfs = 1.5F;

    x2 = number * 0.5F;
    y  = number;
    i  = * ( long * ) &y;                       // evil floating point bit level hacking
    i  = 0x5f3759df - ( i >> 1 );               // what the fuck? 
    y  = * ( float * ) &i;
    y  = y * ( threehalfs - ( x2 * y * y ) );   // 1st iteration
//  y  = y * ( threehalfs - ( x2 * y * y ) );   // 2nd iteration, this can be removed

    return y;
}

```

最后，在自己的PC上实验一下，感受一下知识的力量吧！
<img src="/images/blog/quicksqrt.png" width="80%" alt="quicksqrt" />
